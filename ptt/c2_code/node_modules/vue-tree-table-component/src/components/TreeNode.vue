<template>
  <div>
    <slot
      name="nodeTemplate"
      :row-data="rowData"
      :default-order="defaultOrder"
      :depth="depth"
      :on-open="open"
      :on-toggle="toggle"
      :on-close="close"
    >
      <TreeDefaultNode
        :row-data="rowData"
        :child="childRefs"
        :default-order="defaultOrder"
        :depth="depth"
        :on-open="open"
        :on-toggle="toggle"
        :on-close="close"
      />
    </slot>

    <template v-if="isOpen">
      <div style="box-shadow: 0 0 2px rgba(0, 0, 0, 0.2); padding: 15px 0px">
        <b style="padding-left: 2rem; margin: 15px 0px; display: block"
          >= Приглашенные пользователи =
          <hr />
        </b>

        <template v-for="(child, index) in rowData.referral_users || childRefs">
          <tree-node
            v-if="!isLeaf(child, USERS)"
            :key="index"
            :depth="depth + 1"
            :row-data="child"
            :child="childRefs"
            :default-order="defaultOrder"
          >
            <template #leafTemplate="leafProps">
              <slot name="leafTemplate" v-bind="leafProps" />
            </template>

            <template #nodeTemplate="nodeProps">
              <slot name="nodeTemplate" v-bind="nodeProps" />
            </template>
          </tree-node>

          <tree-leaf
            v-if="isLeaf(child, USERS)"
            :key="index"
            :depth="depth + 1"
            :row-data="child"
            :child="childRefs"
            :default-order="defaultOrder"
          >
            <template #leafTemplate="leafProps">
              <slot name="leafTemplate" v-bind="leafProps" />
            </template>
          </tree-leaf>
        </template>
      </div>
    </template>
  </div>
</template>

<script>
import { mapGetters } from "vuex";
import TreeNode from "./TreeNode";
import TreeLeaf from "./TreeLeaf";
import isLeafFunc from "../utils/isLeaf";
import TreeDefaultNode from "./TreeDefaultNode";

export default {
  name: "TreeNode",
  components: { TreeDefaultNode, TreeLeaf, TreeNode },
  props: {
    rowData: {
      type: Object,
      default: () => {
        return {};
      },
    },
    defaultOrder: {
      type: Array,
      default: () => {
        return [];
      },
    },
    depth: {
      type: Number,
      default: 0,
    },
  },
  data: function () {
    return {
      isOpen: false,
      c: Object,
    };
  },
  computed: {
    ...mapGetters(["USERS"]),
    childRefs: function (rowData, users) {
      let data = isLeafFunc(rowData.rowData, this.USERS);
      if (!data.bool) {
        return (this.c = data.child.referral_users);
      }
    },
  },
  methods: {
    isLeaf(rowData, users) {
      let data = isLeafFunc(rowData, users);
      if (data.bool) {
        return true;
      } else {
        return false;
      }
    },
    toggle() {
      this.isOpen = !this.isOpen;
    },
    open() {
      this.isOpen = true;
    },
    close() {
      this.isOpen = false;
    },
  },
};
</script>

<style scoped>
</style>

